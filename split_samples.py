"""
    split train samples to two parts: train 0.7 test 0.3

    total: 10868

    TODO: 类别间的数据是不平衡的，这里要处理一下

"""
import os
import shutil

import numpy as np
import pandas as pd

BASE_DIR = "/media/xueshan/WD_BLACK/cybersecurity/malaware"
TRAIN_DIR = os.path.join(BASE_DIR, "train")
TEST_DIR = os.path.join(BASE_DIR, "test")
TRAIN_LABEL_CSV = os.path.join(BASE_DIR, "trainLabels.csv")


def main_work():
    df = pd.read_csv(TRAIN_LABEL_CSV)
    dfg = df.groupby(by="Class").count()
    dfg.columns = ["Id Counts"]
    print(dfg)
    print()
    print("total samples:", dfg.sum().values[0])
    # fetch 70% in each class to train sets, the left 30% is test sets
    for class_level in dfg.index.values:
        print("processing:", class_level)
        tdf : pd.DataFrame = df.loc[df["Class"] == class_level,]
        tdf : pd.DataFrame = tdf.iloc[round(len(tdf)*0.8):]
        # just move the 30% to test sets
        for row in tdf.itertuples():
            asm_file = f"{row.Id}.asm"
            byte_file = f"{row.Id}.bytes"
            if not os.path.exists(os.path.join(TRAIN_DIR, asm_file)):
                # continue
                raise Exception("maybe this has been splited")
            shutil.move(os.path.join(TRAIN_DIR, asm_file), os.path.join(TEST_DIR, asm_file))
            shutil.move(os.path.join(TRAIN_DIR, byte_file), os.path.join(TEST_DIR, byte_file))

        print(class_level, "done")



if __name__ == '__main__':
    main_work()
